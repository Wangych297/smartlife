<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartLife - æ™ºèƒ½å¥åº·ä¸ä»»åŠ¡ç®¡ç†</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>SmartLife ç³»ç»Ÿ</h1>
    <div class="points-display">
        <h2>å½“å‰ç§¯åˆ†: {{ user_points }}</h2>
    </div>

    <!-- Flash æ¶ˆæ¯ -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class=flashes>
        {% for category, message in messages %}
          <li class="{{ category }}">{{ message }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <!-- è¡¨å•åŒºåŸŸ -->
    <div class="container forms-container">
        <!-- æ·»åŠ å¥åº·æ•°æ® -->
        <div class="form-section">
            <h2><span class="icon">â•</span> æ·»åŠ å¥åº·æ•°æ®</h2>
            <form action="{{ url_for('add_health') }}" method="post">
                <label for="health_date">æ—¥æœŸ:</label>
                <input type="date" id="health_date" name="health_date" required value="{{ now.strftime('%Y-%m-%d') }}"> <!-- é»˜è®¤å½“å¤© -->

                <label for="health_type">ç±»å‹:</label>
                <input type="text" id="health_type" name="health_type" placeholder="ä¾‹å¦‚: æ­¥æ•°, ç¡çœ å°æ—¶" required>

                <label for="health_value">å€¼:</label>
                <input type="text" id="health_value" name="health_value" placeholder="ä¾‹å¦‚: 10000, 7.5" required>

                <button type="submit">æ·»åŠ æ•°æ®</button>
            </form>
        </div>

        <!-- æ·»åŠ ä»»åŠ¡ -->
        <div class="form-section">
            <h2><span class="icon">ğŸ“</span> æ·»åŠ ä»»åŠ¡</h2>
            <form action="{{ url_for('add_task') }}" method="post">
                <label for="task_description">ä»»åŠ¡æè¿°:</label>
                <input type="text" id="task_description" name="task_description" required>

                <label for="task_priority">ä¼˜å…ˆçº§:</label>
                <select id="task_priority" name="task_priority">
                    <option value="é«˜">é«˜</option>
                    <option value="ä¸­" selected>ä¸­</option>
                    <option value="ä½">ä½</option>
                </select>

                <label for="task_due_date">æˆªæ­¢æ—¥æœŸ:</label>
                <input type="date" id="task_due_date" name="task_due_date">

                <label for="task_group">åˆ†ç»„ (å¯é€‰):</label>
                <input type="text" id="task_group" name="task_group" placeholder="ä¾‹å¦‚: å·¥ä½œ, å­¦ä¹ ">

                <label for="task_tags">æ ‡ç­¾ (å¯é€‰, é€—å·åˆ†éš”):</label>
                <input type="text" id="task_tags" name="task_tags" placeholder="ä¾‹å¦‚: é‡è¦, ç´§æ€¥, è´­ç‰©">

                <button type="submit">æ·»åŠ ä»»åŠ¡</button>
            </form>
        </div>

        <!-- è®¾ç½®å¥åº·ç›®æ ‡ -->
        <div class="form-section">
            <h2><span class="icon">ğŸ¯</span> è®¾ç½®/æ›´æ–°å¥åº·ç›®æ ‡</h2>
            <form action="{{ url_for('set_goal') }}" method="post">
                 <label for="goal_type">ç›®æ ‡ç±»å‹:</label>
                 <input type="text" id="goal_type" name="goal_type" placeholder="ä¾‹å¦‚: æ­¥æ•°, é¥®æ°´æ¯«å‡" required>
                 <!-- æˆ–è€…ç”¨ä¸‹æ‹‰é€‰æ‹©å¸¸è§ç±»å‹ -->
                 <!-- <select id="goal_type" name="goal_type" required>
                    <option value="æ­¥æ•°">æ­¥æ•°</option>
                    <option value="é¥®æ°´æ¯«å‡">é¥®æ°´æ¯«å‡</option>
                    <option value="ç¡çœ å°æ—¶">ç¡çœ å°æ—¶</option>
                 </select> -->

                 <label for="goal_target">ç›®æ ‡å€¼:</label>
                 <input type="number" id="goal_target" name="goal_target" step="any" placeholder="ä¾‹å¦‚: 10000, 2000" required>

                 <label for="goal_period">å‘¨æœŸ:</label>
                 <select id="goal_period" name="goal_period" required>
                     <option value="daily" selected>æ¯æ—¥</option>
                     <option value="weekly">æ¯å‘¨</option>
                 </select>
                 <button type="submit">è®¾ç½®/æ›´æ–°ç›®æ ‡</button>
            </form>
             <!-- æ˜¾ç¤ºå·²è®¾ç½®çš„ç›®æ ‡ -->
             {% if goals %}
             <h4>å·²è®¾ç›®æ ‡:</h4>
             <ul class="goal-list-small">
                {% for goal in goals %}
                <li>
                    {{ goal.type }} ({{ 'æ¯æ—¥' if goal.period == 'daily' else 'æ¯å‘¨' }}): {{ goal.target }}
                    <form action="{{ url_for('delete_goal', goal_id=goal.id) }}" method="post" style="display:inline;">
                        <button type="submit" class="delete-button-small" title="åˆ é™¤ç›®æ ‡" onclick="return confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªç›®æ ‡å—ï¼Ÿ');">Ã—</button>
                    </form>
                </li>
                {% endfor %}
             </ul>
             {% endif %}
        </div>
    </div>

    <!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
    <div class="container data-section">

        <!-- å¥åº·ç›®æ ‡è¿½è¸ª -->
        <div class="list-section goal-tracking-section">
            <h2><span class="icon">ğŸ“Š</span> å¥åº·ç›®æ ‡è¿½è¸ª (ä»Šæ—¥/æœ¬å‘¨)</h2>
            {% if goals %}
                {% for goal in goals %}
                    {% set progress = goal_progress.get(goal.id) %}
                    {% if progress %}
                    <div class="goal-item">
                        <strong>{{ progress.type }} ({{ 'æ¯æ—¥' if progress.period == 'daily' else 'æ¯å‘¨' }})</strong>
                        <p>å‘¨æœŸ: {{ progress.period_str }}</p>
                        <p>è¿›åº¦: {{ progress.current }} / {{ progress.target }}</p>
                        <div class="progress-bar-container">
                             <div class="progress-bar" style="width: {{ [progress.percentage, 100]|min }}%;"> <!-- æœ€å¤§100% -->
                                {{ progress.percentage }}%
                             </div>
                        </div>
                         {% if progress.percentage >= 100 %}
                            <p class="motivation success">ğŸ‰ ç›®æ ‡è¾¾æˆï¼å¤ªæ£’äº†ï¼</p>
                         {% elif progress.percentage >= 75 %}
                            <p class="motivation good">ğŸ‘ å¾ˆæ¥è¿‘äº†ï¼ŒåŠ æ²¹ï¼</p>
                         {% elif progress.percentage >= 50 %}
                            <p class="motivation ok">ğŸ’ª å®Œæˆä¸€åŠäº†ï¼Œç»§ç»­åŠªåŠ›ï¼</p>
                         {% else %}
                             <p class="motivation encouragement">ğŸƒ å¼€å§‹è¡ŒåŠ¨å§ï¼</p>
                         {% endif %}
                    </div>
                    {% else %}
                     <div class="goal-item">
                        <strong>{{ goal.type }} ({{ 'æ¯æ—¥' if goal.period == 'daily' else 'æ¯å‘¨' }})</strong>
                        <p>ç›®æ ‡: {{ goal.target }}</p>
                        <p><i>ä»Šæ—¥/æœ¬å‘¨æš‚æ— ç›¸å…³æ•°æ®æ¥è®¡ç®—è¿›åº¦ã€‚</i></p>
                     </div>
                    {% endif %}
                    <hr>
                {% endfor %}
            {% else %}
                <p>å°šæœªè®¾ç½®ä»»ä½•å¥åº·ç›®æ ‡ã€‚è¯·åœ¨ä¸Šæ–¹è¡¨å•ä¸­è®¾ç½®ã€‚</p>
            {% endif %}
        </div>


        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <div class="list-section task-list-section">
             <div class="list-header">
                <h2><span class="icon">ğŸ“‹</span> ä»»åŠ¡åˆ—è¡¨</h2>
                <!-- è¿‡æ»¤é€‰é¡¹ -->
                <div class="filters">
                    <form method="get" action="{{ url_for('index') }}" style="display: inline;">
                        <label for="status_filter">çŠ¶æ€:</label>
                        <select name="status" id="status_filter" onchange="this.form.submit()">
                            <option value="" {% if not filters_active.status %}selected{% endif %}>æ‰€æœ‰</option>
                            <option value="å¾…åŠ" {% if filters_active.status == 'å¾…åŠ' %}selected{% endif %}>å¾…åŠ</option>
                            <option value="å·²å®Œæˆ" {% if filters_active.status == 'å·²å®Œæˆ' %}selected{% endif %}>å·²å®Œæˆ</option>
                        </select>

                        <label for="group_filter">åˆ†ç»„:</label>
                        <select name="group" id="group_filter" onchange="this.form.submit()">
                            <option value="" {% if not filters_active.group %}selected{% endif %}>æ‰€æœ‰</option>
                            {% for group in all_groups %}
                            <option value="{{ group }}" {% if filters_active.group == group %}selected{% endif %}>{{ group }}</option>
                            {% endfor %}
                        </select>

                        <label for="tag_filter">æ ‡ç­¾:</label>
                        <select name="tag" id="tag_filter" onchange="this.form.submit()">
                            <option value="" {% if not filters_active.tag %}selected{% endif %}>æ‰€æœ‰</option>
                            {% for tag in all_tags %}
                            <option value="{{ tag }}" {% if filters_active.tag == tag %}selected{% endif %}>{{ tag }}</option>
                            {% endfor %}
                        </select>
                        <noscript><button type="submit">ç­›é€‰</button></noscript>
                        {% if filters_active.status or filters_active.group or filters_active.tag %}
                            <a href="{{ url_for('index') }}" class="clear-filter-link">æ¸…é™¤ç­›é€‰</a>
                        {% endif %}
                    </form>
                </div>
            </div>

            {% if tasks %}
            <table>
                <thead>
                    <tr>
                        <th>çŠ¶æ€</th>
                        <th>ä¼˜å…ˆçº§</th>
                        <th>æè¿°</th>
                        <th>åˆ†ç»„</th>
                        <th>æ ‡ç­¾</th>
                        <th>æˆªæ­¢æ—¥æœŸ</th>
                        <!-- <th>æ·»åŠ æ—¶é—´</th> -->
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr class="{{ 'task-done' if task.status == 'å·²å®Œæˆ' else 'task-todo' }}
                               {{ 'task-overdue' if task.reminder_status == 'overdue' }}
                               {{ 'task-upcoming' if task.reminder_status == 'upcoming' }}">
                        <td>{{ task.status }}</td>
                        <td>
                            <span class="priority-{{ task.priority.lower() }}">{{ task.priority }}</span>
                        </td>
                        <td>{{ task.description }}
                           {% if task.reminder_status == 'overdue' %} <span class="reminder-icon overdue">â—å·²è¿‡æœŸ</span>{% endif %}
                           {% if task.reminder_status == 'upcoming' %} <span class="reminder-icon upcoming">ğŸ””å³å°†åˆ°æœŸ</span>{% endif %}
                        </td>
                        <td>{{ task.group or 'æ— ' }}</td>
                        <td>
                           {% if task.tags %}
                               {% for tag in task.tags %}
                                   <span class="tag">{{ tag }}</span>
                               {% endfor %}
                           {% else %}
                               æ— 
                           {% endif %}
                        </td>
                        <td>{{ task.due_date if task.due_date != 'æ— ' else '--' }}</td>
                        <!-- <td>{{ task.timestamp.strftime('%Y-%m-%d %H:%M') }}</td> -->
                        <td>
                            <div class="action-buttons">
                                <!-- çŠ¶æ€åˆ‡æ¢ -->
                                {% if task.status == 'å¾…åŠ' %}
                                <form action="{{ url_for('update_task_status', task_id=task.id, new_status='å·²å®Œæˆ') }}{{ ('?' + request.query_string.decode()) if request.query_string else '' }}" method="post" style="display:inline;">
                                    <button type="submit" class="complete-button" title="æ ‡è®°ä¸ºå·²å®Œæˆ">âœ”</button>
                                </form>
                                {% else %}
                                <form action="{{ url_for('update_task_status', task_id=task.id, new_status='å¾…åŠ') }}{{ ('?' + request.query_string.decode()) if request.query_string else '' }}" method="post" style="display:inline;">
                                    <button type="submit" class="todo-button" title="æ ‡è®°ä¸ºå¾…åŠ">â†©</button>
                                </form>
                                {% endif %}
                                <!-- ç¼–è¾‘æŒ‰é’® -->
                                <a href="{{ url_for('edit_task_page', task_id=task.id) }}" class="edit-button" title="ç¼–è¾‘ä»»åŠ¡">âœï¸</a>
                                <!-- åˆ é™¤æŒ‰é’® -->
                                <form action="{{ url_for('delete_task', task_id=task.id) }}{{ ('?' + request.query_string.decode()) if request.query_string else '' }}" method="post" style="display:inline;">
                                    <button type="submit" class="delete-button" title="åˆ é™¤ä»»åŠ¡" onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ');">ğŸ—‘ï¸</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>æš‚æ— ä»»åŠ¡æ»¡è¶³å½“å‰ç­›é€‰æ¡ä»¶ï¼Œæˆ–è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•ä»»åŠ¡ã€‚</p>
            {% endif %}
        </div>

        <!-- å¥åº·æ•°æ®è®°å½• -->
        <div class="list-section health-data-section">
            <h2><span class="icon">ğŸ’“</span> å¥åº·æ•°æ®è®°å½•</h2>
             {% if health_data %}
            <table>
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>ç±»å‹</th>
                        <th>å€¼</th>
                        <th>è®°å½•æ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in health_data %}
                    <tr>
                        <td>{{ record.date }}</td>
                        <td>{{ record.type }}</td>
                        <td>{{ record.value }}</td>
                        <td>{{ record.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <form action="{{ url_for('delete_health', record_id=record.id) }}" method="post" style="display:inline;">
                                <button type="submit" class="delete-button" title="åˆ é™¤è®°å½•" onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¥åº·æ•°æ®å—ï¼Ÿ');">ğŸ—‘ï¸</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
             {% else %}
            <p>æš‚æ— å¥åº·æ•°æ®ã€‚</p>
             {% endif %}
        </div>

    </div>

    <!-- ç”¨äºæ—¥æœŸé»˜è®¤å€¼ -->
    <script>
        // ç¡®ä¿é»˜è®¤æ—¥æœŸæ˜¯ç”¨æˆ·çš„æœ¬åœ°æ—¥æœŸ
        document.addEventListener('DOMContentLoaded', (event) => {
            const dateInput = document.getElementById('health_date');
            if (dateInput && !dateInput.value) { // ä»…å½“å€¼ä¸ºç©ºæ—¶è®¾ç½®
                 const today = new Date();
                 const yyyy = today.getFullYear();
                 const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-based
                 const dd = String(today.getDate()).padStart(2, '0');
                 dateInput.value = `${yyyy}-${mm}-${dd}`;
            }
        });
    </script>
</body>
</html>